# 数据库设计文档

## 数据库选型

- **开发环境**: SQLite 3
- **生产环境**: PostgreSQL 14+

使用 GORM 作为 ORM 框架，实现数据库无关的代码设计。

## 表结构设计

### 1. groups - 群信息表

| 字段         | 类型         | 约束        | 说明         |
| ------------ | ------------ | ----------- | ------------ |
| id           | BIGINT       | PRIMARY KEY | 群号         |
| name         | VARCHAR(255) |             | 群名称       |
| member_count | INT          | DEFAULT 0   | 当前成员数   |
| created_at   | TIMESTAMP    |             | 记录创建时间 |
| updated_at   | TIMESTAMP    |             | 记录更新时间 |

### 2. members - 群成员表

| 字段       | 类型         | 约束             | 说明                     |
| ---------- | ------------ | ---------------- | ------------------------ |
| id         | BIGINT       | PRIMARY KEY AUTO | 自增 ID                  |
| group_id   | BIGINT       | INDEX            | 群号                     |
| user_id    | BIGINT       | INDEX            | 用户 QQ 号               |
| nickname   | VARCHAR(255) |                  | 昵称                     |
| card       | VARCHAR(255) |                  | 群名片                   |
| role       | VARCHAR(20)  |                  | 角色: owner/admin/member |
| join_time  | TIMESTAMP    |                  | 入群时间                 |
| leave_time | TIMESTAMP    | NULL             | 退群时间                 |
| is_active  | BOOLEAN      | DEFAULT TRUE     | 是否在群中               |
| created_at | TIMESTAMP    |                  | 记录创建时间             |
| updated_at | TIMESTAMP    |                  | 记录更新时间             |

**唯一索引**: (group_id, user_id, join_time)

### 3. member_events - 成员变动事件表

| 字段        | 类型        | 约束             | 说明                      |
| ----------- | ----------- | ---------------- | ------------------------- |
| id          | BIGINT      | PRIMARY KEY AUTO | 自增 ID                   |
| group_id    | BIGINT      | INDEX            | 群号                      |
| user_id     | BIGINT      | INDEX            | 用户 QQ 号                |
| event_type  | VARCHAR(20) |                  | 事件类型: join/leave/kick |
| operator_id | BIGINT      | NULL             | 操作者 ID                 |
| event_time  | TIMESTAMP   | INDEX            | 事件时间                  |
| created_at  | TIMESTAMP   |                  | 记录创建时间              |

**索引**: (group_id, event_time)

### 4. messages - 消息统计表

| 字段           | 类型        | 约束             | 说明         |
| -------------- | ----------- | ---------------- | ------------ |
| id             | BIGINT      | PRIMARY KEY AUTO | 自增 ID      |
| group_id       | BIGINT      | INDEX            | 群号         |
| user_id        | BIGINT      | INDEX            | 用户 QQ 号   |
| message_id     | VARCHAR(64) | UNIQUE           | 消息 ID      |
| message_type   | VARCHAR(20) |                  | 消息类型     |
| content_length | INT         |                  | 内容长度     |
| send_time      | TIMESTAMP   | INDEX            | 发送时间     |
| created_at     | TIMESTAMP   |                  | 记录创建时间 |

**索引**: (group_id, send_time)

### 5. daily_stats - 每日统计表（聚合表）

| 字段          | 类型      | 约束             | 说明         |
| ------------- | --------- | ---------------- | ------------ |
| id            | BIGINT    | PRIMARY KEY AUTO | 自增 ID      |
| group_id      | BIGINT    | INDEX            | 群号         |
| stat_date     | DATE      | INDEX            | 统计日期     |
| member_count  | INT       |                  | 当日成员数   |
| joined_count  | INT       |                  | 新增成员数   |
| left_count    | INT       |                  | 离开成员数   |
| message_count | INT       |                  | 消息总数     |
| active_users  | INT       |                  | 活跃用户数   |
| created_at    | TIMESTAMP |                  | 记录创建时间 |
| updated_at    | TIMESTAMP |                  | 记录更新时间 |

**唯一索引**: (group_id, stat_date)

### 6. hourly_message_stats - 小时消息统计表

| 字段          | 类型      | 约束             | 说明                   |
| ------------- | --------- | ---------------- | ---------------------- |
| id            | BIGINT    | PRIMARY KEY AUTO | 自增 ID                |
| group_id      | BIGINT    | INDEX            | 群号                   |
| stat_hour     | TIMESTAMP | INDEX            | 统计小时（精确到小时） |
| message_count | INT       |                  | 消息数量               |
| active_users  | INT       |                  | 活跃用户数             |
| text_count    | INT       |                  | 文本消息数             |
| image_count   | INT       |                  | 图片消息数             |
| file_count    | INT       |                  | 文件消息数             |
| other_count   | INT       |                  | 其他消息数             |
| created_at    | TIMESTAMP |                  | 记录创建时间           |
| updated_at    | TIMESTAMP |                  | 记录更新时间           |

**唯一索引**: (group_id, stat_hour)

### 7. bot_status - 机器人状态表

| 字段           | 类型        | 约束             | 说明                 |
| -------------- | ----------- | ---------------- | -------------------- |
| id             | BIGINT      | PRIMARY KEY AUTO | 自增 ID              |
| group_id       | BIGINT      | INDEX            | 群号                 |
| bot_id         | BIGINT      |                  | 机器人 QQ 号         |
| status         | VARCHAR(20) |                  | 状态: online/offline |
| last_heartbeat | TIMESTAMP   |                  | 最后心跳时间         |
| created_at     | TIMESTAMP   |                  | 记录创建时间         |
| updated_at     | TIMESTAMP   |                  | 记录更新时间         |

**唯一索引**: (group_id, bot_id)

## ER 图

```
┌─────────────┐       ┌─────────────────┐
│   groups    │───────│    members      │
└─────────────┘       └─────────────────┘
      │                       │
      │               ┌───────┴───────┐
      │               │               │
      ▼               ▼               ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│ daily_stats │ │member_events│ │  messages   │
└─────────────┘ └─────────────┘ └─────────────┘
      │
      ▼
┌──────────────────────┐
│ hourly_message_stats │
└──────────────────────┘
```

## 数据库配置

### SQLite 配置（开发）

```go
dsn := "file:seekyourguild.db?cache=shared&mode=rwc"
```

### PostgreSQL 配置（生产）

```go
dsn := "host=localhost user=postgres password=xxx dbname=seekyourguild port=5432 sslmode=disable"
```

## 数据清理策略

- 消息详情表保留 30 天
- 成员事件表保留 90 天
- 聚合统计表永久保留
